name: Hourly Vercel Log Analysis

on:
  schedule:
    # Run every hour at minute 5 (e.g., 00:05, 01:05, 02:05, etc.)
    - cron: '5 * * * *'
  
  workflow_dispatch: # Allow manual trigger from GitHub Actions UI

jobs:
  analyze-logs:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0 # Fetch all history for proper commits
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Install Vercel CLI
        run: npm install -g vercel@latest
      
      - name: Run hourly log analysis
        id: analysis
        env:
          VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}
          VERCEL_PROJECT_ID: prj_6Eejnjz5gfq1apxkLbrObHi07FCt
          CI: true
        run: |
          # Check if VERCEL_TOKEN is set
          if [ -z "$VERCEL_TOKEN" ]; then
            echo "âš ï¸ VERCEL_TOKEN is not set in repository secrets"
            echo ""
            echo "ðŸ“‹ To enable automated log analysis:"
            echo "1. Create a Vercel token at: https://vercel.com/account/tokens"
            echo "2. Add it to GitHub Secrets at:"
            echo "   https://github.com/${{ github.repository }}/settings/secrets/actions"
            echo "3. Name the secret: VERCEL_TOKEN"
            echo ""
            echo "â„¹ï¸ Skipping log analysis for now..."
            echo "token_available=false" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          echo "token_available=true" >> $GITHUB_OUTPUT
          
          # Login to Vercel using token
          vercel whoami --token "$VERCEL_TOKEN" || vercel login --token "$VERCEL_TOKEN"
          
          # Run analysis script
          ./scripts/analyze-hourly-logs.sh
      
      - name: Apply critical fixes
        if: steps.analysis.outputs.token_available == 'true'
        env:
          VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}
          VERCEL_PROJECT_ID: prj_6Eejnjz5gfq1apxkLbrObHi07FCt
        run: |
          # Run automated fix script
          ./scripts/apply-critical-fixes.sh
      
      - name: Commit and push to PR branch
        if: steps.analysis.outputs.token_available == 'true'
        run: |
          git config --global user.name "GitHub Actions Bot"
          git config --global user.email "actions@github.com"
          
          # Create or switch to automated analysis branch
          git fetch origin
          git checkout automated-log-analysis 2>/dev/null || git checkout -b automated-log-analysis
          
          # Add analysis and any applied fixes
          git add web-site-optimization/ANALYSIS_HISTORY.md 2>/dev/null || true
          git add web-site-optimization/missing-blob-files.txt 2>/dev/null || true
          git add web-site-optimization/SERVERLESS_ALERT.md 2>/dev/null || true
          git add middleware.ts 2>/dev/null || true
          
          if git diff --staged --quiet; then
            echo "No changes to commit"
            exit 0
          fi
          
          # Check if fixes were applied
          FIXES_APPLIED=0
          if git diff --staged --name-only | grep -q "middleware.ts"; then
            FIXES_APPLIED=1
          fi
          
          if [ $FIXES_APPLIED -eq 1 ]; then
            git commit -m "chore: hourly analysis + critical fixes $(date +'%Y-%m-%d %H:%M UTC')"
          else
            git commit -m "chore: hourly log analysis $(date +'%Y-%m-%d %H:%M UTC')"
          fi
          
          # Push to branch (creates/updates PR)
          git push -u origin automated-log-analysis
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Create or update PR
        if: steps.analysis.outputs.token_available == 'true'
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          branch: automated-log-analysis
          title: "ðŸ“Š Automated Hourly Log Analysis"
          body: |
            ## ðŸ“Š Automated Vercel Log Analysis
            
            This PR contains hourly log analyses from the last 24 hours.
            
            ### ðŸ“ˆ What's Included:
            - Hourly traffic statistics (Edge vs Serverless)
            - Monthly usage projections
            - Optimization recommendations
            - Blob storage miss detection
            
            ### âœ… Review & Merge:
            - Review the accumulated analyses in `ANALYSIS_HISTORY.md`
            - Merge when ready (daily or weekly)
            - A new PR will be created for the next batch
            
            **Last Updated**: $(date +'%Y-%m-%d %H:%M UTC')
            
            ---
            *This PR is automatically updated every hour by GitHub Actions*
          labels: |
            automated
            monitoring
            analytics
          draft: false
